{% macro render(field, data) -%}
<div class="{{ field.name }}_wrap">
    {% if field is string %}
        {{ field }}
    {% elif field.label.text == "heading" %}
        {{ render_heading(field) }}
    {% elif field.type == "FieldsetField" %}
        {{ create_fieldset(field) }}
    {% elif field.type == "CKEditorTextAreaField" %}
        {{ render_ckeditor(field) }}
    {% elif field.type == "SelectField" %}
        {{ render_select(field, data) }}
    {% elif field.type == "SelectMultipleField" %}
        {{ render_select_multiple(field) }}
    {% elif field.type == "BooleanField" %}
        {{ render_checkbox(field, data) }}
    {% elif field.type in ["DateField", "DateTimeField"] %}
        {{ render_datepicker(field, data) }}
    {% else %}
        {{ render_field(field, data) }}
    {% endif %}
</div>
{%- endmacro %}

{% macro render_heading(field) -%}
<p> <h3 class="subtitle">{{ field.description }}</h3></p>
<hr/>
{%- endmacro %}

{% macro render_field(field, data) -%}
    {{ render_label(field) }}
    {% if field.name in data %}
        {{ field(value=data[field.name]) }}
    {% else %}
        {{ field }}
    {% endif %}
{%- endmacro %}

{% macro render_select(field, data) -%}
{{ render_label(field) }}
{% if field.name in data %}
    <select class="{{ field.render_kw.class if field.render_kw and 'class' in field.render_kw else '' }}" name="{{ field.name }}">
    {% for value, label in field.choices %}
        {% if value == data[field.name] %}
            <option value="{{ value }}" selected>{{ label }}</option>
        {% else %}
            <option value="{{ value }}">{{ label }}</option>
        {% endif %}
    {% endfor %}
    </select>
{% else %}
    {{ field }}
{% endif %}
{%- endmacro %}

{% macro render_select_multiple(field) -%}
{{ render_label(field) }}
{{ field(size=10, class="large-select") }}
{%- endmacro %}

{% macro render_ckeditor(field) -%}
{{ render_label(field) }}
{{ field(class="ckeditor") }}
{%- endmacro %}

{% macro render_datepicker(field, data) -%}
{{ render_label(field) }}
{% if field.name in data %}
    {{ field(value=data[field.name], class="datepicker") }}
{% else %}
    {{ field(value="", class="datepicker") }}
{% endif %}
{%- endmacro %}

{% macro render_checkbox(field, data) -%}
{% set checked = data and field.name in data and data[field.name] and "Yes" in data[field.name] %}
<input type="hidden" name="{{ field.name }}" value="No" {{ 'disabled' if checked else '' }} />
<label for="{{ field.id }}" id="{{ field.id }}_label" class="checkbox{{ ' checked' if checked else '' }}">
    <span class="icons">
        <span class="first-icon fa fa-square-o"></span>
        <span class="second-icon fa fa-check-square-o"></span>
    </span>
    
    {{ field.label.text }}
    {{ field }}
</label>
{%- endmacro %}

{% macro render_label(field) -%}
{% set field_classes = field.render_kw['class'] if field.render_kw and 'class' in field.render_kw else '' %}
<div id="{{ field.name }}_label" class="{{ field_classes }}">
    <label for="{{ field.name }}">
        {{ field.label.text }}
        {% if field.flags.required %}
        <small class="required">required</small>
        {% endif %}
    </label>
    <small class="extra-required">{{ field.description }}</small>
</div>
{%- endmacro %}

{% macro create_fieldset(field, template=false) -%}
    {% set fieldset_classes = field.name ~ '_fieldset fieldset_template' if template else field.name ~ '_fieldset fieldset' %}
    {% set fieldset_index = 0 if template else 1 %}
    {% if field.data and not template %}
        {% if field.fieldset_type == "multiple" %}
            {% for data in field.data %}
                <fieldset class="{{ fieldset_classes }}" fieldset-id="{{ loop.index }}">
                {{ continue_fieldset(field, loop.index, data) }}
            {% endfor %}
        {% else %}
            <fieldset class="{{ fieldset_classes }}" fieldset-id="{{ fieldset_index }}">
            {{ continue_fieldset(field, fieldset_index, field.data) }}
        {% endif %}
    {% else %}
        <fieldset class="{{ fieldset_classes }}" fieldset-id="{{ fieldset_index }}">
        {{ continue_fieldset(field, fieldset_index, {}) }}
    {% endif %}
    {% if field.fieldset_type == "multiple" and not template %}
    <a href="javascript:void(0);" id="add_{{ field.name }}_button" class="btn btn-primary" onclick="duplicateFieldset('{{ field.name }}')">Add Another {{ field.label.text }}</a><br /><br />
    {% endif %}
{%- endmacro %}

{% macro continue_fieldset(field, fieldset_index, data) -%}
        <div class="card">
            <div class="content">
                {% if field.fieldset_type == "multiple" %}
                <legend>{{ field.label.text }} <span class="fieldset_number">{{ fieldset_index }}</span>
                {% else %}
                <legend>{{ field.label.text }}
                {% endif %}
                    {% if field.required %}
                    <small class="required">required</small>
                    {% endif %}
                    {% if field.fieldset_type == "multiple" %}
                    <i class="fa fa-times fa-delete" class="{{ field.name }}-delete" onclick="removeFieldset(this)"></i>
                    {% endif %}
                </legend>
                {% for f in field.fields %}
                    {{ render(f, data) }}
                {% endfor %}
            </div>
        </div>
    </fieldset>
{%- endmacro %}

{% extends "tinker_base.html" %}

{% set title = 'Events' %}

{% block page_title %}
    {% if new_form %}
        Add a new event
    {% else %}
        Edit your event
    {% endif %}
{% endblock %}

{% block main_content %}
    <div class="content">
        <div class="container-fluid">
            <div class="col-md-12">
                <p>If you have any questions as you submit your event, please contact Conference and Event Services
                    at
                    651.638.6090.</p>
                <div id="fieldset-templates" style="display: none;">
                    {% for field in form if field.type == "FieldsetField" %}
                        {{ create_fieldset(field, template=true) }}
                    {% endfor %}
                </div>
                {% if new_form %}
                    <form id="eventform" action="{{ url_for('EventsView:submit') }}" method="post">
                {% else %}
                    <form id="eventform" action="{{ url_for('EventsView:submit') }}" method="post">
                    <input type="hidden" name="event_id" id="event_id" value="{{ event_id }}"/>
                {% endif %}
                {{ form.hidden_tag() }}
                {% if (not dates_good and num_dates) or form.errors %}
                    <div class="error-alert">
                        <div data-alert class="red-alert">
                            There were errors with your form
                        </div>
                    </div>
                {% endif %}

                {# Render the fields #}
                {% for field in form if field.widget.input_type != 'hidden' %}

                    {# Print any errors for this field#}
                    {% for error in form.errors[field.name] %}
                        <div class="error-alert">
                            <div data-alert class="red-alert">
                                {{ error }}
                            </div>
                        </div>
                    {% endfor %}

                    {# Print the field #}
                    {{ render(field) }}
                    
                {% endfor %}
                <button type="submit" formmethod="post" id="event-submit-btn" class="btn btn-primary">Submit</button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}


{% block scripts %}

<script src="{{ url_for('static', filename='moment.js') }}"></script>
<script src="{{ url_for('static', filename='ckeditor/ckeditor.js') }}"></script>

<link rel="stylesheet" href="{{ url_for('static', filename='pikaday.css') }}">

<style>
    .visually-hidden {
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0,0,0,0) !important;
        border: 0 !important;
    }
</style>

<script src="{{ url_for('static', filename='pikaday.js') }}"></script>
<script src="{{ url_for('static', filename='pikaday.jquery.js') }}"></script>

<script type="text/javascript">

function checkboxClicked(label) {
    var $checkbox = $(label).find('input[type="checkbox"]');
    var $card = $(label).closest('.card');
    var name = $checkbox.attr('name');
    var $hiddenInput = $card.find("input[type='hidden'][name='" + name + "']");
    if ($checkbox.is(':checked')) {
        $hiddenInput.prop('disabled', false);
    } else {
        $hiddenInput.prop('disabled', true);
    }
}

function selectChanged(select) {
    var val = $(select).val();
    var selectOptions = $(select).find("option").map(function () {
        return $(this).val();
    }).get();
    selectOptions.forEach(function(option) {
        // Only proceed if the option is a valid class name
        if (!option) return;
        if (!/^[A-Za-z0-9_-]+$/.test(option)) return;

        if (option.includes("_fieldset")) {
            element = $("." + option);
        } else {
            element = $("." + option + "_wrap");
        }
        if (element.length === 0) return;
        if (option !== val) {
            element.addClass('visually-hidden');
            clearValuesWithin(element);
        } else {
            element.removeClass('visually-hidden');
            element.find('*').each(function () {
                // Show all elements within the wrap, except those with class 'fieldset_template'
                if (!$(this).hasClass('fieldset_template')) {
                    $(this).removeClass('visually-hidden');
                }
            });
        }
    });
}

function toggleFieldsetField(element, className, checkedAction, isInit) {

    wrap = $(element).closest('fieldset').find('.' + className + '_wrap');
    showField = $(element).hasClass('checked');

    if (isInit) {
        if (checkedAction === 'show') {
            showField = true; // Force show if initializing
        } else {
            showField = false; // Force hide if initializing
        }
    } else {
        // Reverse the state if we are showing
        if (checkedAction === 'show') {
            showField = !showField;
        }
    }

    if (showField) {
        wrap.find('*').each(function () {
            if ($(this).is('input, select, textarea')) {
                var label = $(this).closest('.card').find("label[for='" + $(this).attr('name') + "']");
                if (label.find('small.required').length > 0) {
                    $(this).attr('required', 'required');
                }
            }
            $(this).removeClass('visually-hidden');
        });
    } else {
        wrap.find('*').each(function () {
            $(this).removeAttr('required');
            $(this).addClass('visually-hidden');
        });
        clearValuesWithin(wrap); // Clear values within the wrap
    }
}

function clearValuesWithin(element) {
    $(element).find("select").each(function () {
        $(this).prop('selectedIndex', 0);
    });
    $(element).find("input[type='checkbox'], input[type='radio']").each(function () {
        $(this).prop("checked", false);
    });
    $(element).find("label").each(function () {
        $(this).removeClass('checked');
        if ($(this).attr('onclick')) {
            $(this).trigger('click');
        }
    });
    $(element).find("input:not([type='checkbox']):not([type='radio']):not([type='select'])").each(function () {
        $(this).removeAttr('value');
    });
}

function removeFieldset(element) {
    var fieldset = $(element).closest('fieldset');
    if (fieldset.length) {
        fieldsetName = getFieldsetName(fieldset);
        fieldset.remove();
        updateFieldsets(fieldsetName);
    }
}

function updateFieldsets(name) {
    // Get all fieldsets with the specified fieldset name
    var sets = $("." + name + "_fieldset").not(".fieldset_template");
    var id = 1;
    // Hide the delete icon for the first fieldset if there is only one
    if (sets.length < 2) {
        sets.first().find(".fa-delete").addClass("visually-hidden");
    } else {
        sets.first().find(".fa-delete").removeClass("visually-hidden");
    }

    // Update the order of the ids
    sets.first().attr("fieldset-id", id);
    sets.first().find("span.fieldset_number").text(id);

    // Show the delete icon for all other fieldsets
    sets.slice(1).each(function () {
        $(this).find(".fa-delete").removeClass("visually-hidden");
        // Update the fieldset-id and number
        id++;
        $(this).attr("fieldset-id", id);
        $(this).find("span.fieldset_number").text(id);
    });

    sets.each(function () {
        $(this).find('.card').find('input, select').each(function () {
            $(this).removeAttr('id');
            var name = $(this).attr('name');
            if (name && !name.endsWith('[]')) {
                var fieldClass = $(this).closest('.card').parent('fieldset').attr('class').split(' ')[0];
                $(this).attr('name', fieldClass + '::' + name + '[]');
                var inputId = $(this).attr('name');
                $(this).closest('.card').find("label[for='" + name + "']").attr('for', inputId);
            }
        });
    });

    // Update the value of the hidden num_ input to the total number of fieldsets
    //$("input[name='num_" + name + "']").val(sets.length);
};

function fillEndDate(element) {
    // If the end date input is empty, set it to the value of the start date input
    var endDateInput = $(element).closest('fieldset').find("input[name='date_end']");
    if (endDateInput.length && !endDateInput.val()) {
        endDateInput.val($(element).val());
    }
}

function addDatePickers(element) {
    $(element).find('.datepicker').each(function (index) {
        var picker = new Pikaday({
            field: this,
            format: 'MMMM Do YYYY, h:mm a',
            showTime: true
        });
    });
}

function getFieldsetName(element) {
    var classes = $(element).attr('class').split(/\s+/);
    var fieldsetName = null;
    for (var i = 0; i < classes.length; i++) {
        var match = classes[i].match(/^(.+)_fieldset$/);
        if (match && match[1]) {
            fieldsetName = match[1];
            break;
        }
    }
    return fieldsetName;
}

function duplicateFieldset(name) {
    // Get the incrementd id from the last fieldset of the specified name
    var lastFieldset = $("." + name + "_fieldset").last();
    var id = parseInt(lastFieldset.attr("fieldset-id")) + 1;

    // Clone the fieldset template
    var newFieldset = $("." + name + "_fieldset.fieldset_template").first().clone();
    newFieldset.attr("fieldset-id", id);
    newFieldset.removeClass("fieldset_template");
    newFieldset.addClass("fieldset");

    // Update the legend
    var fieldsetNumberSpan = newFieldset.find("span.fieldset_number");
    if (fieldsetNumberSpan.length) {
        fieldsetNumberSpan.text(id);
    }

    addDatePickers(newFieldset);
    newFieldset.insertAfter(lastFieldset);

    updateFieldsets(name);
}

$(document).ready(function () {

    // Apply all checkbox onclick actions to the label
    $('label.checkbox').each(function () {
        var input = $(this).find('input[type="checkbox"]');
        var onclickAction = input.attr('onclick');
        if (onclickAction) {
            $(this).attr('onclick', onclickAction);
            var onclickStr = onclickAction.toString();

            if ($(this).hasClass('checked')) {
                var match = onclickStr.match(/toggleFieldsetField\(([^)]*)\)/);
                if (match) {
                    // Evaluate the arguments safely
                    var args = match[1].split(',').map(function(arg) {
                        arg = arg.trim();
                        if (arg.startsWith("'") && arg.endsWith("'")) {
                            return arg.slice(1, -1);
                        } else if (arg.startsWith('"') && arg.endsWith('"')) {
                            return arg.slice(1, -1);
                        } else if (arg === "this") {
                            return this;
                        } else {
                            return arg;
                        }
                    }.bind(this));
                    toggleFieldsetField.apply(null, [...args, true]);
                }
            }

            input.removeAttr('onclick');
        }
    });

    // Create datepicker for starting date fields
    $('.datepicker').each(function (index) {
        var picker = new Pikaday({
            field: this,
            format: 'MMMM Do YYYY, h:mm a',
            showTime: true
        });
    });

    // Update all fieldsets to ensure they are correctly initialized
    $('.fieldset').each(function () {
        var fieldsetName = getFieldsetName(this);
        if (fieldsetName) {
            updateFieldsets(fieldsetName);
        }
    });

    // Ensure visibility is set based on the dropdown values
    $('select').each(function() {
        selectChanged(this);
    });
});

</script>

{% endblock %}
